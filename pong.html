<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<link href="ui.css" rel="stylesheet"/>
		<title>weGGe Pong</title>
	</head>
	
	<body>	
	</body>

	<script src="lib/three.js" language="javascript"></script>	
	<script src="lib/physi.js" language="javascript"></script>	
	<script>
		'use strict';

		Physijs.scripts.worker = 'lib/physijs_worker.js';
		Physijs.scripts.ammo = 'ammo.js';
	</script>
	
	<script src="lib/jquery.min.js" language="javascript"></script>
	<script src="lib/helvetiker_regular.typeface.js" language="javascript"></script>

	<script src="js/tools.js" language="javascript"></script>
	<script src="js/host3d.js" language="javascript"></script>
	<script src="js/controls.js" language="javascript"></script>
	<script src='lib/MTLLoader.js'></script>
	<script src='lib/OBJMTLLoader.js'></script>
	<script src='lib/threex.spaceships.js'></script>

	<script src="js/nodes/node.js" language="javascript"></script>	
	<script src="js/nodes/level.js" language="javascript"></script>
	<script src="js/nodes/objects/object.js" language="javascript"></script>
	<script src="js/nodes/objects/group.js" language="javascript"></script>
	<script src="js/nodes/objects/basic.js" language="javascript"></script>
	<script src="js/nodes/objects/mesh.js" language="javascript"></script>
	<script src="js/nodes/objects/plane.js" language="javascript"></script>
	<script src="js/nodes/objects/lines.js" language="javascript"></script>
	<script src="js/nodes/objects/spaceship.js" language="javascript"></script>
	<script src="js/nodes/objects/dynamic.js" language="javascript"></script>
	
	<script src="js/nodes/resources/resources.js" language="javascript"></script>
	<script src="js/nodes/resources/resource.js" language="javascript"></script>
	<script src="js/nodes/resources/material.js" language="javascript"></script>
	<script src="js/nodes/resources/phy_material.js" language="javascript"></script>
	<script src="js/nodes/resources/texture.js" language="javascript"></script>
	<script src="js/nodes/resources/model.js" language="javascript"></script>
	
	<script src="js/nodes/actors/actor.js" language="javascript"></script>
	<script src="js/nodes/actors/clickable.js" language="javascript"></script>
	<script src="js/nodes/actors/moving.js" language="javascript"></script>
	<script src="js/nodes/actors/turning.js" language="javascript"></script>
	<script src="js/nodes/actors/spawn.js" language="javascript"></script>
	<script src="js/nodes/actors/physics.js" language="javascript"></script>
	
	<script src="js/ui/ui.js" language="javascript"></script>
	<script src="js/ui/viewer.js" language="javascript"></script>
	<script src="js/ui/resources.js" language="javascript"></script>

	<script>
	
		var viewer;
	
		var pongialized = false;
		var cube_actor, left_hand, right_hand, wall_up, wall_down, wall_left, wall_right;
		
		var blasts, cube_dynamic;
		
		function pushLeft(args) {			
			if (pongialized) {
				cube_actor.pushZ(-_coalesce(args,250));
			}
		}
		
		function pushRight(args) {			
			if (pongialized) {
				cube_actor.pushZ(_coalesce(args,250));
			}
		}
		
		function pushUp(args) {			
			if (pongialized) {
				cube_actor.pushY(_coalesce(args,100));
			}
		}
		
		function pushDown(args) {			
			if (pongialized) {
				cube_actor.pushY(-_coalesce(args,100));
			}
		}
		
		function onKeyDown(e) {
			var key = e.keyCode ? e.keyCode : e.charCode;
			console.log("key:" + key);
			switch( key ) {
				case 87: /* W */
					rightHandUp();
					break;				
				case 83: /* S */
					rightHandDown();
					break;
				case 65: /* A */
					//pushLeft();
					break;
				case 68: /* D */
					//pushRight();
					break;	
				case 32: /* space */
					shoot();
					break;					
			}
		}
		
		function onKeyUp(e) {
			var key = e.keyCode ? e.keyCode : e.charCode;
			console.log("key:" + key);
			switch( key ) {
				case 87: /* W */
					stopRightHand()
					break;				
				case 83: /* S */
					stopRightHand()
					break;
				case 37: /* left */
					pushLeft();
					break;
				case 39: /* right */
					pushRight();
					break;				
				case 27: /*ESC*/
					viewer.loadLevelList();
			}
		}
	
		var lh_moving = false;
		var lh_up = false;

		var rh_moving = false;		
		var rh_up = false;
		var rh_hasCube = false;
		
		var rh_shot = false;
		var cube_vert = 0;
		
		function stopRightHand() {
			if (pongialized) {
				rh_moving = false;
			}
		}
		
		function rightHandUp() {
			if (pongialized) {
				rh_moving = true;
				rh_up = true;
			}
		}
		
		function rightHandDown() {
			if (pongialized) {
				rh_moving = true;
				rh_up = false;
			}
		}
		
		var mouseX, mouseY;
		
		function onMouseMove(event) {
			if (mouseY > event.pageY) {
				rightHandUp();
			} else if (mouseY < event.pageY) {
				rightHandDown();
			}
			mouseX = event.pageX;
			mouseY = event.pageY;
		}
		
		function shoot() {
			pushLeft(350);
			rh_hasCube = false;
			if (rh_moving) {
				if (rh_up) {
					cube_vert = 1;
					pushUp();
				} else {
					cube_vert = -1;
					pushDown();
				}
			}			
		}
		
		function restartGame() {
			cube_actor.target.wrapper.position.copy(right_hand.wrapper.position);
			cube_actor.target.wrapper.position.z -= 10;
			cube_actor.target.wrapper.__dirtyPosition = true;
			cube_actor.target.wrapper.rotation.set(0,0,0);
			cube_actor.target.wrapper.__dirtyRotation = true;	
			cube_actor.target.wrapper.setAngularVelocity(_v(0,0,0));
			cube_actor.target.wrapper.setLinearVelocity(_v(0,0,0));
			cube_vert = 0;
			rh_hasCube = true;
		}
		
		var tail_time = 0;
		
		function animationFrame(delta) {
			if (rh_moving) {
				if (rh_up) {
					right_hand.wrapper.position.y += 10;					
				} else {
					right_hand.wrapper.position.y -= 10;
				}
				right_hand.wrapper.__dirtyPosition = true;
				if (rh_hasCube) {
					cube_actor.target.wrapper.position.copy(right_hand.wrapper.position);
					cube_actor.target.wrapper.position.z -= 10;
					cube_actor.target.wrapper.__dirtyPosition = true;
					cube_actor.target.wrapper.setLinearVelocity(_v(0,0,0));					
				}				
			}
			tail_time -= delta;
			if (!rh_hasCube && (tail_time <= 0)) {
				cube_dynamic.create(cube_actor.target.wrapper.position,1);
				tail_time = 0.1;
			}
		}
		
		function cubeVertApply() {
			if (cube_vert > 0) {
				pushUp();
			} else if (cube_vert < 0) {
				pushDown();
			}
		}
		
		function cubeHit( other_object, relative_velocity, relative_rotation, contact_normal ) {
			if (pongialized) {
				blasts.create(cube_actor.target.wrapper.position,2.5);
						
				if (other_object === left_hand.wrapper) {
					if (lh_moving) {
						if (lh_up) {
							cube_vert = 1;
						} else {
							cube_vert = -1;
						}
					}
					cubeVertApply();
					//pushRight(5);
					rh_shot = false;
				} else if (other_object === right_hand.wrapper) {
					if (rh_moving) {
						if (rh_up) {
							cube_vert = 1;
						} else {
							cube_vert = -1;
						}
					}
					cubeVertApply();
					//pushLeft(5);
					rh_shot = true;
				} else if (other_object === wall_up.wrapper) {
					if (rh_shot) {						
						pushLeft();
					} else {
						pushRight();
					}
					cube_vert = -1;
				} else if (other_object === wall_down.wrapper) {
					if (rh_shot) {						
						pushLeft();
					} else {
						pushRight();						
					}
					cube_vert = 1;
				}
			}			
		}
		
		function initPong() {
			cube_actor = viewer.level.findNodeByName("cube_actor");
			cube_actor.target.wrapper.setAngularFactor(_v(0,0,0));
			cube_actor.target.wrapper.setLinearFactor(_v(0,1,1));
			
			// Enable CCD if the object moves more than 1 meter in one simulation frame
			cube_actor.target.wrapper.setCcdMotionThreshold(10);

			// Set the radius of the embedded sphere such that it is smaller than the object
			cube_actor.target.wrapper.setCcdSweptSphereRadius(0.2);
		
			cube_actor.target.wrapper.addEventListener( 'collision', cubeHit);
			
			cube_dynamic = viewer.level.findNodeByName("cube_dynamic");
						
			wall_left = viewer.level.findNodeByName("wall_left");
			wall_left.wrapper.addEventListener( 'collision', function( other_object, relative_velocity, relative_rotation, contact_normal ) {
				restartGame();		
			});
			
			wall_right = viewer.level.findNodeByName("wall_right");
			wall_right.wrapper.addEventListener( 'collision', function( other_object, relative_velocity, relative_rotation, contact_normal ) {
				restartGame();		
			});
			
			wall_up = viewer.level.findNodeByName("wall_up");
			wall_down = viewer.level.findNodeByName("wall_down");
						
			left_hand = viewer.level.findNodeByName("left_hand");
			left_hand.wrapper.setLinearFactor(_v(0,1,0));
			left_hand.wrapper.setAngularFactor(_v(0,0,0));
			
			right_hand = viewer.level.findNodeByName("right_hand");
			right_hand.wrapper.setLinearFactor(_v(0,1,0));
			right_hand.wrapper.setAngularFactor(_v(0,0,0));
			
			blasts = viewer.level.findNodeByName("dynamic_blasts");
			
			window.document.addEventListener( 'keyup', onKeyUp );
			window.document.addEventListener( 'keydown', onKeyDown );
			//window.document.addEventListener( 'mousemove', onMouseMove );
	
			viewer.level.animated.push({animationFrame:animationFrame});
			
			pongialized = true;
			restartGame();
		}
		
		$(function () {
			viewer = new weggeViewer();
			viewer.onLevelLoaded = initPong;
			viewer.startLoadingLevel(31);			
		});
		
	</script>
		
</html>

